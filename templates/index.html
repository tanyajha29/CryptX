<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Secure Encryptor — CyberX 2.0</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    </head>
<body>
    <div class="overlay">
        <div class="popup" role="dialog" aria-modal="true">
            <div class="header-section">
                <div>
                    <h1>Secure Encryptor</h1>
                    <p class="lead">Encrypt messages with **randomized, multi-layered ciphers** and simulate advanced attacks.</p>
                </div>
                <div class="demo-tag">Demo simulation</div>
            </div>

            <div class="input-group">
                <label for="message">Message</label>
                <textarea id="message" placeholder="Type message here... "></textarea>
            </div>
            
            <div class="input-group">
                <label for="session_id">Session ID (Required for Decrypt/Simulate)</label>
                <input type="text" id="session_id" placeholder="Enter session ID... ">
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="doEncrypt()">Encrypt</button>
                <button class="btn btn-success" onclick="doDecrypt()">Decrypt</button>
                <button class="btn btn-warning" onclick="doSimulate()">Simulate Attack</button>
            </div>

            <div class="main-output-area">
                <div class="main-output" id="main-output">Awaiting action...</div>
            </div>

            <div class="simulation-results" id="sim-results" style="display: none;">
                <hr>
                <div class="strength-meter">
                    <div class="strength-header">
                        <span class="strength-percent" id="strength-percent">0%</span>
                        <span class="strength-label" id="strength-label">Weak</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <p class="progress-label" id="sim-conclusion">Run simulation to analyze ciphertext strength...</p>
                </div>
                
                <div class="sim-findings" id="sim-findings"></div>
                <div class="sim-attack-list" id="sim-attack-list"></div>

                <div class="candidates" id="sim-candidates" style="display: none;">
                    <h3>Brute-Force Candidates Found:</h3>
                    <pre id="cand-list"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Utility Functions (Keep them simple)
        const getSessionID = () => document.getElementById("session_id").value.trim();
        const getMessage = () => document.getElementById("message").value;
        const setOutput = (text, isError = false) => {
            const output = document.getElementById("main-output");
            output.innerText = text;
            output.style.color = isError ? 'var(--color-fail)' : 'var(--color-text-light)';
        };

        const setStrengthUI = (strength, label) => {
            const bar = document.getElementById("progress-bar");
            const percent = document.getElementById("strength-percent");
            const sLabel = document.getElementById("strength-label");

            bar.style.width = `${strength}%`;
            percent.innerText = `${strength}%`;
            sLabel.innerText = label;

            if (strength >= 80) {
                bar.style.background = 'linear-gradient(90deg, #4ade80, #16a34a)'; // Strong
            } else if (strength >= 50) {
                bar.style.background = 'linear-gradient(90deg, #FACC15, #B45309)'; // Medium (Amber)
            } else {
                bar.style.background = 'linear-gradient(90deg, #F87171, #B91C1C)'; // Weak (Red)
            }
        };

        const fetchData = async (endpoint, data) => {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(data).toString()
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.result || result.message || `Error ${response.status}`);
                }
                return result;
            } catch (error) {
                setOutput(`Operation Failed: ${error.message}`, true);
                return null;
            }
        };

        // Main Actions
        const doEncrypt = async () => {
            const message = getMessage();
            if (!message) return setOutput("Error: Message is required for encryption.", true);
            
            setOutput("Encrypting...", false);
            const data = await fetchData('/encrypt', { message });
            
            if (data) {
                document.getElementById("session_id").value = data.session_id;
                setOutput(data.result);
                document.getElementById("sim-results").style.display = "none";
                document.getElementById("message").value = message; // Keep original message
            }
        };

        const doDecrypt = async () => {
            const session_id = getSessionID();
            if (!session_id) return setOutput("Error: Session ID is required for decryption.", true);
            
            setOutput("Decrypting...", false);
            const data = await fetchData('/decrypt', { session_id });
            
            if (data) {
                setOutput(data.result);
                document.getElementById("message").value = data.result;
                document.getElementById("sim-results").style.display = "none";
            }
        };

        const doSimulate = async () => {
            const session_id = getSessionID();
            if (!session_id) return setOutput("Error: Session ID is required for simulation.", true);

            setOutput("Running multi-layered attack simulation...", false);
            document.getElementById("sim-results").style.display = "block";
            
            const data = await fetchData('/simulate', { session_id });

            if (data && data.status === "ok") {
                setOutput(`Simulation Complete. Strength: ${data.strength_label}`, false);
                
                // Set strength bar
                setStrengthUI(data.strength, data.strength_label);

                // show findings (quick)
                const fdiv = document.getElementById("sim-findings");
                fdiv.innerHTML = `<strong>Entropy:</strong> ${data.entropy}   <strong>Base64-like:</strong> ${data.is_base64}`;

                // NEW: Display individual attack scores
                const al = document.getElementById("sim-attack-list");
                al.innerHTML = '<strong>Attack Scores (Direct Layer):</strong>';
                data.findings.forEach(f => {
                    const color = f.success ? '#ef4444' : '#22c55e'; // Invert colors to show success as fail (weakness)
                    al.innerHTML += `<div class="sim-attack-score">${f.type}: <span style="color:${color};">Score ${f.score}</span></div>`;
                });


                // show candidates if any
                if(data.candidates && data.candidates.length){
                    document.getElementById("sim-candidates").style.display = "block";
                    const cl = document.getElementById("cand-list");
                    cl.innerText = "";
                    data.candidates.forEach(c => {
                        cl.innerText += `--- ${c.type} (score=${c.score}) meta:${c.meta}\n${c.plaintext}\n\n`;
                    });
                } else {
                    document.getElementById("sim-candidates").style.display = "none";
                }

                document.getElementById("sim-conclusion").innerText = data.conclusion;

            } else if (data) {
                 setOutput(`Simulation Error: ${data.message}`, true);
                 document.getElementById("sim-results").style.display = "none";
            }
        };
    </script>
</body>
</html>